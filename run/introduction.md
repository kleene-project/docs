---
title: Managing your runtime environments
description: "Overview"
keywords: "docker, run, configure, runtime"
---

Kleened runs processes in isolated containers. A container is one or more processes
running in an isolated runtime environment on a host machine.
The host may be local or remote. When an operator executes `klee run`, a container
is created and a process is started within that container. This means that the
process runs in an isolated environment with its own file system, its own networking,
and its own isolated process tree separate from the host.

In FreeBSD terms the process is 'jailed' using the jail kernel functionalty and it
can be managed using native FreeBSD tooling. Some of these is being used by Kleene
under the hood, but some of the tools can be relevant to use alongside Kleene as
well.

The degree of isolation can be adjusted in many ways, and will be discussed in the
following sections.

## Creating and running containers

The most common way of using containers with the client is to use the command
[`klee run`](/engine/reference/commandline/run).
This command combines [`klee container create`](/engine/reference/commandline/container_create) and
[`klee container start`](/engine/reference/commandline/start/).
I.e., running

```console
$ klee container create FreeBSD:testing echo Hello!
433b69dfc748
$ klee container start 433b
created execution instance 1671b5124e42
Hello!

executable 1671b5124e42 and its container exited with exit-code 0
```

and

```console
$ klee run FreeBSD:testing echo Hello!
24644efab9a3
created execution instance f2f4d2ef6c26
Hello!

executable f2f4d2ef6c26 and its container exited with exit-code 0
```

are equivalent. A few things to notice with these two examples:

- In both cases, Kleene generated a unique ID for the container when
  it was created, and printed it to the user on the first line. Since no name was
  set with `--name`, Kleene autogenerated one for the container, but did not
  print it. Run `klee lsc -a` to see the names of the containers.

- Kleene also created an execution instance when the container is started.
  An execution instance is a ephemeral object in Kleene that represents a spawned
  process. A running container can have more than one execution instance and the
  user can create more with Klee using `klee exec`.

- When starting the container manually, it is enough to refer to the container using
  an initial segment of the ID, as long as it is unique across all container ID's.
  You can also refer to a container by it's name, however, then the entire name must
  be used.

- Lastly, the containers do not have connectivity since no network was specified
  (using `--network`/`-n`) when the containers were created. An easy way to get
  started with networking is in the [Get started](/get-started) guide
  and a thorough discussion is given in the [networking section](FIXME)
  following this introduction.

## Detached vs. foreground

When starting a Kleene container, you can decide if the container should run
immediately in the background using the `--detach` flag or in the default
foreground mode.

```console
$ klee run FreeBSD:test echo Hello!
8752dee80656
created execution instance 7726cb9f5299
Hello!

executable 7726cb9f5299 and its container exited with exit-code 0
```

The default behaviour is to print output from the container. However,
this can be disabled using `--detach`:

```console
$ klee run --detach FreeBSD:test echo Hello!
4a687b420ed
created execution instance acba96f0411c
```

and then Kleene will start the container, run the command and then exit immediately.
In this particular case, as we can see in the previous attached example, the command
exists immediately. However, if it was a long-running command it would show up when
listing containers with `klee lsc`.

## Running containers in the foreground

When running containers in the foreground (the default), `klee run` starts the
process in the container and relays the STDOUT and STDERR of the running process
to the terminal:

```
$ klee run FreeBSD:testing
a33acc099268
created execution instance 94455a51098c
ELF ldconfig path: /lib /usr/lib /usr/lib/compat
32-bit compatibility ldconfig path: /usr/lib32
/etc/rc: WARNING: $hostname is not set -- see rc.conf(5).
Updating motd:.
Creating and/or trimming log files.
Clearing /tmp (X related).
Updating /var/run/os-release done.
Starting syslogd.
/etc/rc: WARNING: failed to start syslogd
Starting sendmail_submit.
554 5.3.0 host "localhost" unknown: Protocol not supported
/etc/rc: WARNING: failed to start sendmail_submit
Starting sendmail_msp_queue.
Starting cron.

Tue Feb 13 13:04:21 UTC 2024

94455a51098c has exited with exit-code 0
```

Notice the last line compared to the previously created containers exit-message.
It only says that the execution instance has exited. There is no mention of the
container because it is stille running. Check with `klee lsc`.
If the process that startede the container exists but it has spawned other
processes that are still running the container is still runnning.

## Accessing a running container

Since containers usually have a full-blown userland they can be accessed and
managed with many of the same tools as the host, albeit in a restricted environment.

There are two different ways of doing this. Either by using `klee` or using FreeBSD's
native tool [`jexec(8)`](https://man.freebsd.org/cgi/man.cgi?query=jexec).

### Using `klee`

Klee's commands for starting containers/execution instances, such as `klee run` and
`klee exec` supports interactive sessions:

- With the `-i`/`--interactive` flag, Kleene redirects terminal STDIN to STDIN of
  the containerized process.

- With the `-t`/`--tty` flag Kleene allocates a [pseudo-TTY](https://man.freebsd.org/cgi/man.cgi?query=pty&)
  which is needed in order for certain interactive applications such as `sh`,
  `bash` etc. to work properly.

For interactive processes (like a shell), you must use `-i -t` together in
order to allocate a tty for the container process. `-i -t` is usually written `-it`.

The advantage of using the Kleene client is that it wraps the interactive session
with relevant information such container/execution instance ID's an whether the
container terminated or just the execution instance. It can also run on a remote
machine instead of the Kleene host. The drawback is that it communicates through
a websocket which incurs some overhead.

### Using `jexec`

FreeBSD comes with its own tool for executing commands inside a container/jail.
It is straightforward to use and it works seamlessly with Kleene containers.
You can use the JID or the (entire) container ID to identify the container.
See [`jexec(8)`](https://man.freebsd.org/cgi/man.cgi?query=jexec) for details.

The advantage of using jexec instead of Klee is that it is simple and fast
(written in C). The drawback is that jexec only works on the host.

## Image identification

When containers are created, they are created from an image which can be specified
using this compressed form:

```
IMAGE_ID|IMAGE_NAME[:tag][@snapshot]
```

which is explained in detail in documentation of
[`klee container create`](/engine/reference/commandline/container_create).
It is worth noting that it is also possible to create images from build snapshots
as described [here](/build/building/snapshots). This can be useful during image
development.

## Overriding image defaults

An image can be equipped with parameters that also affects the runtime environment,
i.e., the container. These can be overwritte when creating/running containers.

Recalling the general form of `klee run`

```
klee run [OPTIONS] IMAGE [COMMAND]...
```

The following Dockerfile instructions has a corresponding override
in `klee run`/`klee create`/etc.

| Dockerfile | Klee          | Description                                                                      |
|------------|---------------|----------------------------------------------------------------------------------|
| `CMD`      | `COMMAND`     | If you omit `COMMAND` the `CMD` of the image is used.                            |
|------------|---------------|----------------------------------------------------------------------------------|
| `ENV`      | `-e`/`--env`  | Specifying environment variables with Klee overrides existing ones if the exist. |
|------------|---------------|----------------------------------------------------------------------------------|
| `USER`     | `-u`/`--user` | If no explicit user is set by the image it is root by default.                   |

In order to see what default values that comes with the image use
`klee image inspect`.
